---
title: "Untitled"
author: "Vaishali"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

---
title: "Untitled"
author: "Vaishali"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
```


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(knitr)
library(lubridate)
setwd("C:/Users/VWaghmare/Git/C113/LabRecon")
getwd()
library(haven)

```{r}
sample<- read_sas("C:/Users/VWaghmare/Git/C113/Data/sample.sas7bdat")
View(sample)
dt <- sample %>% select(SUBJID, SPSTAT, VISIT, VISITNUM, SPDTTM) %>% filter(SPSTAT == '1') %>% mutate(SAMPLE_COL_DATE = as_date(dmy_hm(SPDTTM))) %>% mutate(Merge_Dt = as_date(dmy_hm(SPDTTM))) %>% mutate(VISNUM = case_when(
  VISITNUM =="D1" ~ "V2",
  VISITNUM =="D3" ~ "V3",
  VISITNUM =="D8" ~ "V4",
  TRUE ~ " "
)) %>% mutate(edc_sub = SUBJID)
View(dt)

lab_dt<- read_csv("C:/Users/VWaghmare/Git/C113/LabRecon/lab_data_11Mar2025.csv")
View(lab_dt)
lab <- lab_dt %>% mutate(VISNUM = Visit) %>% mutate(SUBJID = `Subject ID`) %>% mutate(Lab_Draw_date = as.Date(`Date Drawn`, format = "%m/%d/%Y")) %>%  mutate(Merge_Dt = as.Date(`Date Drawn`, format = "%m/%d/%Y"))
View(lab)

#merge lab data and EDC data

vislab<- full_join(dt, lab, by =c("SUBJID", "VISNUM"))
View(vislab)



vislab_c <- vislab %>% mutate(flag = case_when(
    is.na(edc_sub) ~ 'Not in EDC',
    is.na(`Subject ID`)~ 'Not in Lab',
    TRUE ~ " "
)
)
View(vislab_c)




final <- vislab_c  %>%  select(SUBJID, VISIT, Visit,VISNUM,`Date Drawn`, `Material Type`, `Material Modifiers`, SAMPLE_COL_DATE, Lab_Draw_date, flag ) %>% mutate(
  SUBJID = labelled(SUBJID, label = "Subject ID"),
  VISIT = labelled(VISIT, label ="EDC Visit"),
  Visit = labelled(Visit, label ="Lab Visit"),
  VISNUM = labelled(VISNUM, label ="Visit Number"),
  `Date Drawn` = labelled(`Date Drawn`, label ="Collection Date"),
  `Material Type` = labelled(`Material Type`, label ="Material Type"),
  `Material Modifiers` = labelled(`Material Modifiers`, label ="Material Modifiers"),
  flag = labelled(flag, label ="Flag"),
)
View(final)

```

final_ <- final %>% mutate(
         flag = ifelse(flag== " " & Lab_Draw_date != SAMPLE_COL_DATE, "Date flag", flag)
         )  %>% filter(flag != " ") %>% select(SUBJID, VISIT, VISNUM, SAMPLE_COL_DATE, Lab_Draw_date, `Material Type`, `Material Modifiers`,  flag ) %>% mutate(
         flag = labelled(flag, label = "Flag"), 
         SAMPLE_COL_DATE= labelled(SAMPLE_COL_DATE, label = "Sample Collection Date"),
         Lab_Draw_date = labelled(Lab_Draw_date, label = "Lab Draw Date")
         ) %>% mutate(lab_dt = as.Date(as.numeric(Lab_Draw_date, format = "%Y/%m/%d")) )
         
View(final_)

library(expss)


my_labels <- c(lab_dt = 'Lab Draw Date')

install.packages("Hmisc")
library("Hmisc")
final_c <- final_
label(final_c) <-as.list(my_labels[match(names(final_c), names(my_labels))])
View(final_c)


install.packages(c("openxlsx", "labelled"))
library(openxlsx)
library(labelled)


get_var_labels <- function(data) {
  sapply(data, var_label)
}

# Get variable labels
var_labels <- get_var_labels(final_)

# Create a copy of the data frame
final_with_labels <- final_

# Replace column names with variable labels
colnames(final_with_labels) <- unname(var_labels)

#get today's date
today <- Sys.Date()
tdt <- format(today, "%Y-%m-%d")
# Create the filename
filename <- paste0("C113_Lab_recon_", tdt, ".xlsx")

# Create a workbook
wb <- createWorkbook()

# Add a sheet with a specific name 
addWorksheet(wb, sheetName = "Lab Recon")

# Write the data to the sheet
writeData(wb, sheet = "Lab Recon", x = final_with_labels)

# Save the workbook
saveWorkbook(wb, file = filename,overwrite = TRUE)



#write.xlsx(final_with_labels, file = "C:/Users/VWaghmare/Git/C113/LabRecon/output/lab_recon.xlsx")








